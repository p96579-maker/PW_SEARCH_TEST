(async function(){const $=s=>document.querySelector(s);const selSys=$("#selSystem"),selCat=$("#selCategory"),selEqp=$("#selEquipment"),showBtn=$("#showBtn"),results=$("#results"),count=$("#count"),meta=$("#meta");let DATA=[];try{const r=await fetch('assets/data.json?_='+Date.now());DATA=await r.json()}catch(e){}meta.textContent=(DATA?.length||0)+' rows';const uniq=a=>[...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y,'en'));function fill(sel,vals,all){const prev=sel.value;sel.innerHTML='';const mk=(v,l)=>{const o=document.createElement('option');o.value=v;o.textContent=v||l;return o};sel.appendChild(mk('',all));vals.forEach(v=>sel.appendChild(mk(v,all)));sel.value=vals.includes(prev)?prev:''}function buildSystem(){fill(selSys,uniq(DATA.map(d=>d.System)),'All systems');selSys.disabled=false;changeSystem()}function changeSystem(){const sys=selSys.value;const subset=sys?DATA.filter(d=>d.System===sys):DATA;fill(selCat,uniq(subset.map(d=>d.Category)),'All categories');selCat.disabled=false;changeCategory()}function changeCategory(){const sys=selSys.value,cat=selCat.value;let subset=DATA.slice();if(sys)subset=subset.filter(d=>d.System===sys);if(cat)subset=subset.filter(d=>d.Category===cat);fill(selEqp,uniq(subset.map(d=>d.Equipment)),'All equipment');selEqp.disabled=false;showBtn.disabled=!(selSys.value||selCat.value||selEqp.value)}function getFiltered(){const sys=selSys.value,cat=selCat.value,eqp=selEqp.value;let s=DATA.slice();if(sys)s=s.filter(d=>d.System===sys);if(cat)s=s.filter(d=>d.Category===cat);if(eqp)s=s.filter(d=>d.Equipment===eqp);return s.filter(d=>(d['Login ID']||d['Password']||d['IP']||d['Remark']||d['Category']||d['Equipment']))}function render(){const rows=getFiltered();results.innerHTML='';if(!rows.length){results.classList.add('hidden');count.classList.add('hidden');return}results.classList.remove('hidden');count.classList.remove('hidden');count.textContent=rows.length+' result'+(rows.length>1?'s':'');const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));rows.forEach(r=>{const card=document.createElement('div');card.className='card';const title=document.createElement('div');title.className='title';const pill=document.createElement('span');pill.className='badge';pill.textContent=r.System||'—';const label=document.createElement('div');label.innerHTML=`<b>${esc(r.Category||'Uncategorized')}</b> · ${esc(r.Equipment||'Unnamed')}`;title.appendChild(pill);title.appendChild(label);const kv=document.createElement('div');kv.className='kvs';const ipv4Re=/\b(?:25[0-5]|2[0-4]\d|1?\d{1,2})(?:\.(?:25[0-5]|2[0-4]\d|1?\d{1,2})){3}\b/g;function splitIPs(t){const s=String(t||'').trim();if(!s)return[];const ips=s.match(ipv4Re)||[];if(ips.length>1)return ips;return s.replace(/\s*-\s*/g,',').replace(/[;|/]/g,',').split(/,\s*/).filter(Boolean)}function splitNumbered(t){const s=String(t||'').trim();if(!s)return[];const toks=s.split(/\s*(?:\d+\)|\d+\.)\s*/).filter(Boolean);if(toks.length>1)return toks;const parts=s.split(/\n+| {2,}|;|(?:\s*&\s*)/).map(x=>x.trim()).filter(Boolean);if(parts.length>1)return parts;const parts2=s.split(/\)\s+(?=[A-Za-z0-9])/).map(x=>x.trim()).filter(Boolean);return parts2.length>1?parts2:[s]}function addRow(k,v){const K=document.createElement('div');K.className='k';K.textContent=k;const V=document.createElement('div');V.textContent=v;kv.appendChild(K);kv.appendChild(V)}function addMulti(k,val,field){let lines=[];if(field==='IP')lines=splitIPs(val);else lines=splitNumbered(val);if(!lines.length)return;addRow(k,lines[0]);for(let i=1;i<lines.length;i++){addRow('',lines[i])}}addMulti('Login ID',r['Login ID'],'Login ID');addMulti('Password',r['Password'],'Password');addMulti('IP',r['IP'],'IP');addMulti('Note',r['Remark'],'Note');card.appendChild(title);card.appendChild(kv);results.appendChild(card)})}selSys.addEventListener('change',()=>{changeSystem();results.classList.add('hidden');count.classList.add('hidden');showBtn.disabled=!(selSys.value||selCat.value||selEqp.value)});selCat.addEventListener('change',()=>{changeCategory();results.classList.add('hidden');count.classList.add('hidden');showBtn.disabled=!(selSys.value||selCat.value||selEqp.value)});selEqp.addEventListener('change',()=>{showBtn.disabled=!(selSys.value||selCat.value||selEqp.value)});document.addEventListener('click',e=>{if(e.target&&e.target.id==='clearBtn'){selSys.value='';changeSystem();selCat.value='';changeCategory();selEqp.value='';results.classList.add('hidden');count.classList.add('hidden');showBtn.disabled=true}});showBtn.addEventListener('click',render);buildSystem()})();